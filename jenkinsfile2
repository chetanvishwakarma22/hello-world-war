pipeline {
    agent any
    environment {
        ARTIFACT_URL = 'http://13.126.190.58:8082/artifactory/hello-world-war-libs-release/com/efsavage/hello-world-war/1.0.50/hello-world-war-1.0.50.war'
        TOMCAT_PATH = '/opt/apache-tomcat-10.1.34'
    }
    stages {
        stage('Download and Deploy Artifact') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'artifactory-credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    sh """
                    # Ensure Jenkins has permission to write in Tomcat's webapps directory
                    sudo chown -R jenkins:jenkins \$TOMCAT_PATH/webapps
                    sudo chmod -R 775 \$TOMCAT_PATH/webapps

                    # Navigate to webapps and clean up the old deployment
                    cd \$TOMCAT_PATH/webapps
                    rm -rf hello-world-war*

                    # Download the new WAR file
                    curl -L -u "\$USERNAME:\$PASSWORD" -O "\$ARTIFACT_URL"

                    # Restart Tomcat
                    cd \$TOMCAT_PATH/bin
                    ./shutdown.sh
                    sleep 10
                    ./startup.sh
                    """
                }
            }
        }
    }
}
